services:
  # LAYER 0: CORE INFRASTRUCTURE
  postgres:
    image: postgres:16-alpine
    container_name: antigravity-v13-postgres-1
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks: [antigravity_mesh]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  starrocks:
    image: starrocks/allin1-ubuntu:latest
    container_name: antigravity-v13-starrocks-1
    ports:
      - "9030:9030"
      - "8030:8030"
    networks: [antigravity_mesh]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/api/health"]
      interval: 20s
      timeout: 10s
      retries: 10

  # LAYER 6: BRAIN (ORCHESTRATOR)
  orchestrator:
    build: .
    container_name: antigravity-v13-orchestrator-1
    ports:
      - "8080:8080"
    environment:
      - STARROCKS_HOST=starrocks
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks: [antigravity_mesh]
    depends_on:
      postgres: { condition: service_healthy }
      starrocks: { condition: service_healthy }

  # LAYER 8: PORTAL (MASTER UI)
  master-ui:
    build: ./src/master-ui
    container_name: antigravity-v13-master-ui-1
    ports:
      - "1055:80"
    networks: [antigravity_mesh]
    depends_on:
      - orchestrator

networks:
  antigravity_mesh:
    driver: bridge
