<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antigravity Node v13.0</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/css/xterm.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape@3/dist/cytoscape.min.js"></script>
  <style>
    :root {
      --ag-accent: #00d4ff;
      --ag-accent-dim: rgba(0, 212, 255, 0.15);
      --ag-green: #22c55e;
      --ag-red: #ef4444;
      --ag-yellow: #eab308;
      --ag-gray: #6b7280;
    }

    /* Override Pico defaults for tighter layout */
    :root:where([data-theme="dark"]) {
      --pico-background-color: #0f172a;
      --pico-card-background-color: #1e293b;
      --pico-card-border-color: #334155;
      --pico-primary: #00d4ff;
      --pico-primary-hover: #22d3ee;
    }

    :root:where([data-theme="light"]) {
      --pico-primary: #0284c7;
      --pico-primary-hover: #0369a1;
    }

    body {
      padding: 0;
      margin: 0;
    }

    /* Top navigation bar */
    .top-bar {
      background: var(--pico-card-background-color);
      border-bottom: 1px solid var(--pico-card-border-color);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .top-bar h1 {
      font-size: 1.25rem;
      margin: 0;
      color: var(--ag-accent);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .top-bar .version-badge {
      font-size: 0.7rem;
      background: var(--ag-accent-dim);
      color: var(--ag-accent);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.4rem;
      vertical-align: middle;
    }

    .status-dot.healthy { background: var(--ag-green); box-shadow: 0 0 6px var(--ag-green); }
    .status-dot.degraded { background: var(--ag-yellow); box-shadow: 0 0 6px var(--ag-yellow); }
    .status-dot.unknown { background: var(--ag-gray); }
    .status-dot.unhealthy { background: var(--ag-red); box-shadow: 0 0 6px var(--ag-red); }

    .theme-toggle {
      background: none;
      border: 1px solid var(--pico-card-border-color);
      color: var(--pico-color);
      cursor: pointer;
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .theme-toggle:hover {
      border-color: var(--ag-accent);
      color: var(--ag-accent);
    }

    /* Main container */
    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Section headers */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      cursor: pointer;
      user-select: none;
    }

    .section-header h2 {
      font-size: 1.1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-header .chevron {
      transition: transform 0.2s;
      font-size: 0.8rem;
      color: var(--pico-muted-color);
    }

    .section-header .chevron.collapsed {
      transform: rotate(-90deg);
    }

    /* Health dashboard */
    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .health-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1rem;
      transition: border-color 0.2s;
    }

    .health-card:hover {
      border-color: var(--ag-accent);
    }

    .health-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .health-card-header .layer-tag {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--ag-accent);
    }

    .health-card-header .layer-name {
      font-size: 0.8rem;
      color: var(--pico-muted-color);
    }

    .check-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.3rem 0;
      font-size: 0.85rem;
    }

    .check-row .check-name {
      color: var(--pico-color);
    }

    .check-status {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
    }

    .check-status.ok {
      background: rgba(34, 197, 94, 0.15);
      color: var(--ag-green);
    }

    .check-status.fail {
      background: rgba(239, 68, 68, 0.15);
      color: var(--ag-red);
    }

    /* Service grid */
    .service-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .layer-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1rem 1.25rem;
    }

    .layer-card h3 {
      font-size: 0.9rem;
      margin: 0 0 0.75rem 0;
      color: var(--ag-accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .layer-card h3 .layer-num {
      background: var(--ag-accent-dim);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .service-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .service-list li {
      padding: 0.35rem 0;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--pico-color);
    }

    .service-list li .svc-icon {
      font-size: 0.7rem;
      color: var(--pico-muted-color);
    }

    /* Quick links */
    .quick-links {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .quick-link {
      display: block;
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1.25rem;
      text-decoration: none;
      color: var(--pico-color);
      transition: border-color 0.2s, transform 0.1s;
    }

    .quick-link:hover {
      border-color: var(--ag-accent);
      transform: translateY(-2px);
      color: var(--pico-color);
    }

    .quick-link .link-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.3rem;
      color: var(--ag-accent);
    }

    .quick-link .link-desc {
      font-size: 0.8rem;
      color: var(--pico-muted-color);
    }

    .quick-link .link-path {
      font-size: 0.7rem;
      font-family: monospace;
      color: var(--pico-muted-color);
      margin-top: 0.4rem;
      opacity: 0.7;
    }

    /* Capabilities section */
    .capabilities-panel {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .cap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .cap-group h4 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--ag-accent);
      margin: 0 0 0.5rem 0;
    }

    .cap-item {
      font-size: 0.82rem;
      padding: 0.25rem 0;
      color: var(--pico-color);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .cap-item code {
      font-size: 0.75rem;
      background: var(--ag-accent-dim);
      padding: 0.1rem 0.35rem;
      border-radius: 3px;
      color: var(--ag-accent);
    }

    /* Loading / error states */
    .htmx-indicator {
      display: none;
    }

    .htmx-request .htmx-indicator {
      display: inline-block;
    }

    .loading-text {
      color: var(--pico-muted-color);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--pico-muted-color);
      font-size: 0.75rem;
      border-top: 1px solid var(--pico-card-border-color);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard { padding: 1rem; }
      .health-grid { grid-template-columns: 1fr; }
      .service-grid { grid-template-columns: 1fr; }
      .quick-links { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 480px) {
      .quick-links { grid-template-columns: 1fr; }
    }

    /* Budget Dashboard */
    .budget-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .budget-summary {
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .budget-summary .spend-amount {
      font-weight: 700;
      color: var(--ag-accent);
      font-size: 1.1rem;
    }

    .budget-summary .spend-limit {
      color: var(--pico-muted-color);
    }

    .budget-chart-container {
      position: relative;
      max-height: 250px;
    }

    /* Log Terminal */
    .log-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .log-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .log-status {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.82rem;
    }

    .log-status .ws-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .log-status .ws-dot.connected { background: var(--ag-green); box-shadow: 0 0 4px var(--ag-green); }
    .log-status .ws-dot.disconnected { background: var(--ag-red); box-shadow: 0 0 4px var(--ag-red); }
    .log-status .ws-dot.reconnecting { background: var(--ag-yellow); box-shadow: 0 0 4px var(--ag-yellow); }

    .log-clear-btn {
      background: none;
      border: 1px solid var(--pico-card-border-color);
      color: var(--pico-color);
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.78rem;
    }

    .log-clear-btn:hover {
      border-color: var(--ag-accent);
      color: var(--ag-accent);
    }

    .terminal-container {
      border-radius: 8px;
      overflow: hidden;
    }

    /* Memory Browser */
    .memory-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .memory-search {
      margin-bottom: 0.75rem;
    }

    .memory-search input {
      font-size: 0.85rem;
      padding: 0.5rem 0.75rem;
      background: var(--pico-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 6px;
      color: var(--pico-color);
      width: 100%;
      max-width: 400px;
    }

    .memory-search input::placeholder {
      color: var(--pico-muted-color);
    }

    .memory-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    .memory-table th {
      text-align: left;
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid var(--pico-card-border-color);
      color: var(--ag-accent);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .memory-table td {
      padding: 0.45rem 0.6rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.4);
      color: var(--pico-color);
      vertical-align: top;
    }

    .memory-table tr:hover td {
      background: var(--ag-accent-dim);
    }

    .memory-table .content-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .memory-pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-top: 0.75rem;
      font-size: 0.82rem;
    }

    .memory-pagination button {
      background: none;
      border: 1px solid var(--pico-card-border-color);
      color: var(--pico-color);
      cursor: pointer;
      padding: 0.3rem 0.7rem;
      border-radius: 4px;
      font-size: 0.78rem;
    }

    .memory-pagination button:hover:not(:disabled) {
      border-color: var(--ag-accent);
      color: var(--ag-accent);
    }

    .memory-pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .memory-pagination .page-info {
      color: var(--pico-muted-color);
    }

    /* SQL Console */
    .sql-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .sql-editor {
      width: 100%;
      min-height: 180px;
      font-family: "Cascadia Code", "Fira Code", "Consolas", monospace;
      font-size: 0.85rem;
      line-height: 1.5;
      background: #0c1222;
      color: #e2e8f0;
      border: 1px solid var(--pico-card-border-color);
      border-radius: 6px;
      padding: 0.75rem 1rem;
      resize: vertical;
      tab-size: 2;
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
    }

    .sql-editor:focus {
      outline: none;
      border-color: var(--ag-accent);
      box-shadow: 0 0 0 2px var(--ag-accent-dim);
    }

    .sql-editor::placeholder {
      color: #475569;
    }

    .sql-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.75rem;
      gap: 0.75rem;
    }

    .sql-toolbar button {
      background: var(--ag-accent-dim);
      border: 1px solid var(--ag-accent);
      color: var(--ag-accent);
      cursor: pointer;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: 600;
      transition: background 0.15s, color 0.15s;
    }

    .sql-toolbar button:hover:not(:disabled) {
      background: var(--ag-accent);
      color: #0f172a;
    }

    .sql-toolbar button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .sql-toolbar .sql-meta {
      font-size: 0.78rem;
      color: var(--pico-muted-color);
    }

    .sql-results {
      margin-top: 1rem;
      max-height: 350px;
      overflow: auto;
      border: 1px solid var(--pico-card-border-color);
      border-radius: 6px;
    }

    .sql-results table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .sql-results th {
      text-align: left;
      padding: 0.45rem 0.6rem;
      border-bottom: 1px solid var(--pico-card-border-color);
      color: var(--ag-accent);
      font-weight: 600;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      position: sticky;
      top: 0;
      background: var(--pico-card-background-color);
      z-index: 1;
    }

    .sql-results td {
      padding: 0.35rem 0.6rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.3);
      color: var(--pico-color);
      white-space: nowrap;
      max-width: 280px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sql-results tr:hover td {
      background: var(--ag-accent-dim);
    }

    .sql-error {
      margin-top: 0.75rem;
      padding: 0.6rem 0.85rem;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 6px;
      color: var(--ag-red);
      font-size: 0.82rem;
      font-family: "Cascadia Code", "Fira Code", monospace;
    }

    .sql-truncated {
      margin-top: 0.5rem;
      padding: 0.35rem 0.6rem;
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.25);
      border-radius: 4px;
      color: var(--ag-yellow);
      font-size: 0.78rem;
    }

    /* Workflow DAG */
    .dag-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .dag-toolbar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .dag-toolbar select {
      font-size: 0.82rem;
      padding: 0.4rem 0.6rem;
      background: var(--pico-background-color);
      border: 1px solid var(--pico-card-border-color);
      border-radius: 6px;
      color: var(--pico-color);
      flex: 1;
      max-width: 400px;
    }

    .dag-toolbar select:focus {
      outline: none;
      border-color: var(--ag-accent);
    }

    .dag-toolbar button {
      background: none;
      border: 1px solid var(--pico-card-border-color);
      color: var(--pico-color);
      cursor: pointer;
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
      font-size: 0.78rem;
      transition: border-color 0.15s, color 0.15s;
    }

    .dag-toolbar button:hover {
      border-color: var(--ag-accent);
      color: var(--ag-accent);
    }

    .dag-canvas {
      width: 100%;
      height: 400px;
      background: #0c1222;
      border: 1px solid var(--pico-card-border-color);
      border-radius: 6px;
      position: relative;
    }

    .dag-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--pico-muted-color);
      font-size: 0.85rem;
      text-align: center;
      padding: 2rem;
    }

    .dag-legend {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.6rem;
      font-size: 0.75rem;
      color: var(--pico-muted-color);
    }

    .dag-legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .dag-legend-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
  </style>
</head>
<body x-data="dashboard()">
  <!-- Top Bar -->
  <header class="top-bar">
    <div class="top-bar-left">
      <h1>Antigravity Node</h1>
      <span class="version-badge">v13.0</span>
      <span id="global-status"
            hx-get="/api/health"
            hx-trigger="load, every 10s"
            hx-target="#health-content"
            hx-select="#health-content"
            hx-swap="none">
        <span class="status-dot" :class="globalStatus"></span>
        <span x-text="globalStatusText" style="font-size:0.85rem;"></span>
      </span>
    </div>
    <button class="theme-toggle" @click="toggleTheme()" x-text="theme === 'dark' ? 'Light Mode' : 'Dark Mode'"></button>
  </header>

  <main class="dashboard">

    <!-- Health Dashboard -->
    <section>
      <div class="section-header" @click="sections.health = !sections.health">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.health }">&#9660;</span>
          Health Dashboard
        </h2>
        <small style="color:var(--pico-muted-color); font-size:0.75rem;">Polls every 10s</small>
      </div>
      <div x-show="sections.health" x-transition>
        <div id="health-content"
             hx-get="/api/health"
             hx-trigger="load, every 10s"
             hx-swap="innerHTML">
          <p class="loading-text">Connecting to orchestrator...</p>
        </div>
      </div>
    </section>

    <!-- Service Grid -->
    <section>
      <div class="section-header" @click="sections.services = !sections.services">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.services }">&#9660;</span>
          Service Architecture
        </h2>
        <small style="color:var(--pico-muted-color); font-size:0.75rem;">30 containers, 6 layers</small>
      </div>
      <div x-show="sections.services" x-transition>
        <div class="service-grid">
          <div class="layer-card">
            <h3><span class="layer-num">L0</span> Infrastructure</h3>
            <ul class="service-list">
              <li><span class="svc-icon">&#9670;</span> PostgreSQL &mdash; Metadata store</li>
              <li><span class="svc-icon">&#9670;</span> SeaweedFS &mdash; Object storage (S3)</li>
              <li><span class="svc-icon">&#9670;</span> NATS &mdash; Event bus</li>
              <li><span class="svc-icon">&#9670;</span> etcd &mdash; K3D backing store</li>
            </ul>
          </div>
          <div class="layer-card">
            <h3><span class="layer-num">L1</span> Orchestration</h3>
            <ul class="service-list">
              <li><span class="svc-icon">&#9670;</span> K3D &mdash; Lightweight Kubernetes</li>
              <li><span class="svc-icon">&#9670;</span> Argo Workflows &mdash; DAG engine</li>
            </ul>
          </div>
          <div class="layer-card">
            <h3><span class="layer-num">L2</span> Services</h3>
            <ul class="service-list">
              <li><span class="svc-icon">&#9670;</span> StarRocks &mdash; Analytics + memory</li>
              <li><span class="svc-icon">&#9670;</span> Valkey &mdash; Cache (Redis-compatible)</li>
              <li><span class="svc-icon">&#9670;</span> Milvus &mdash; Vector search</li>
              <li><span class="svc-icon">&#9670;</span> Keycloak &mdash; Identity / OIDC</li>
              <li><span class="svc-icon">&#9670;</span> OpenBao &mdash; Secrets (Vault fork)</li>
              <li><span class="svc-icon">&#9670;</span> OVMS &mdash; Model serving (OpenVINO)</li>
            </ul>
          </div>
          <div class="layer-card">
            <h3><span class="layer-num">L3</span> Agent</h3>
            <ul class="service-list">
              <li><span class="svc-icon">&#9670;</span> MCP Gateway &mdash; Tool routing</li>
              <li><span class="svc-icon">&#9670;</span> Goose &mdash; AI agent runtime</li>
              <li><span class="svc-icon">&#9670;</span> MCP StarRocks &mdash; SQL tools</li>
              <li><span class="svc-icon">&#9670;</span> MCP Filesystem &mdash; File tools</li>
            </ul>
          </div>
          <div class="layer-card">
            <h3><span class="layer-num">L4</span> Observability</h3>
            <ul class="service-list">
              <li><span class="svc-icon">&#9670;</span> Budget Proxy &mdash; LLM cost control</li>
              <li><span class="svc-icon">&#9670;</span> Perses &mdash; Dashboards (Grafana alt)</li>
              <li><span class="svc-icon">&#9670;</span> OpenSearch &mdash; Log aggregation</li>
              <li><span class="svc-icon">&#9670;</span> Fluent Bit &mdash; Log shipper</li>
              <li><span class="svc-icon">&#9670;</span> Marquez &mdash; Data lineage</li>
            </ul>
          </div>
          <div class="layer-card">
            <h3><span class="layer-num">L5</span> Interface</h3>
            <ul class="service-list">
              <li><span class="svc-icon">&#9670;</span> LibreChat &mdash; Chat UI</li>
              <li><span class="svc-icon">&#9670;</span> Master UI &mdash; This dashboard</li>
              <li><span class="svc-icon">&#9670;</span> Trace Viewer &mdash; Thought inspection</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Quick Links -->
    <section>
      <div class="section-header" @click="sections.links = !sections.links">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.links }">&#9660;</span>
          Quick Links
        </h2>
      </div>
      <div x-show="sections.links" x-transition>
        <div class="quick-links">
          <a href="/chat/" class="quick-link">
            <div class="link-title">Chat</div>
            <div class="link-desc">LibreChat conversational interface with episodic memory</div>
            <div class="link-path">/chat/</div>
          </a>
          <a href="/argo/" class="quick-link">
            <div class="link-title">Workflows</div>
            <div class="link-desc">Argo DAG engine for multi-step agent pipelines</div>
            <div class="link-path">/argo/</div>
          </a>
          <a href="/lineage/" class="quick-link">
            <div class="link-title">Lineage</div>
            <div class="link-desc">Marquez data lineage explorer and job tracking</div>
            <div class="link-path">/lineage/</div>
          </a>
          <a href="/dashboards/" class="quick-link">
            <div class="link-title">Dashboards</div>
            <div class="link-desc">Perses metrics visualization and alerting</div>
            <div class="link-path">/dashboards/</div>
          </a>
          <a href="/trace/" class="quick-link">
            <div class="link-title">Thought Trace</div>
            <div class="link-desc">Inspect agent reasoning chains and decision paths</div>
            <div class="link-path">/trace/</div>
          </a>
        </div>
      </div>
    </section>

    <!-- Budget Dashboard -->
    <section>
      <div class="section-header" @click="sections.budget = !sections.budget">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.budget }">&#9660;</span>
          Budget Dashboard
        </h2>
        <small style="color:var(--pico-muted-color); font-size:0.75rem;" x-show="budgetLoaded">
          <span class="spend-amount" x-text="'$' + budgetSpend.toFixed(2)"></span>
          <span class="spend-limit" x-text="' / $' + budgetLimit.toFixed(2) + ' daily'"></span>
        </small>
      </div>
      <div x-show="sections.budget" x-transition>
        <div class="budget-card">
          <div class="budget-summary" x-show="budgetLoaded">
            <span>Current spend:</span>
            <span class="spend-amount" x-text="'$' + budgetSpend.toFixed(2)"></span>
            <span class="spend-limit" x-text="'of $' + budgetLimit.toFixed(2) + ' daily limit (' + budgetCurrency + ')'"></span>
          </div>
          <div class="budget-summary" x-show="!budgetLoaded">
            <span class="loading-text">Loading budget data...</span>
          </div>
          <div class="budget-chart-container">
            <canvas id="budgetChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Live Logs -->
    <section>
      <div class="section-header" @click="toggleLogs()">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.logs }">&#9660;</span>
          Live Logs
        </h2>
        <div class="log-status">
          <span class="ws-dot" :class="wsStatus"></span>
          <span x-text="wsStatusText" style="font-size:0.78rem; color:var(--pico-muted-color);"></span>
        </div>
      </div>
      <div x-show="sections.logs" x-transition>
        <div class="log-card">
          <div class="log-toolbar">
            <div class="log-status">
              <span class="ws-dot" :class="wsStatus"></span>
              <span x-text="wsStatusText"></span>
            </div>
            <button class="log-clear-btn" @click="clearTerminal()">Clear</button>
          </div>
          <div class="terminal-container" id="terminal-container"></div>
        </div>
      </div>
    </section>

    <!-- Memory Browser -->
    <section>
      <div class="section-header" @click="sections.memory = !sections.memory">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.memory }">&#9660;</span>
          Memory Browser
        </h2>
        <small style="color:var(--pico-muted-color); font-size:0.75rem;"
               x-show="memoryTotal > 0" x-text="memoryTotal + ' entries'"></small>
      </div>
      <div x-show="sections.memory" x-transition>
        <div class="memory-card">
          <div class="memory-search">
            <input type="text"
                   placeholder="Search memory entries..."
                   x-model="memorySearch"
                   @input.debounce.300ms="fetchMemory(true)">
          </div>
          <table class="memory-table" x-show="memoryEntries.length > 0">
            <thead>
              <tr>
                <th>Time</th>
                <th>Actor</th>
                <th>Type</th>
                <th>Content</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="entry in memoryEntries" :key="entry.event_id">
                <tr>
                  <td x-text="formatTime(entry.timestamp)"></td>
                  <td x-text="esc(entry.actor || '')"></td>
                  <td x-text="esc(entry.action_type || '')"></td>
                  <td class="content-cell" x-text="truncate(entry.content, 80)"></td>
                </tr>
              </template>
            </tbody>
          </table>
          <p class="loading-text" x-show="memoryEntries.length === 0 && memoryLoaded">No entries found.</p>
          <p class="loading-text" x-show="!memoryLoaded">Loading memory...</p>
          <div class="memory-pagination" x-show="memoryTotalPages > 1">
            <button @click="memoryPrev()" :disabled="memoryPage <= 1">&#9664; Previous</button>
            <span class="page-info" x-text="'Page ' + memoryPage + ' of ' + memoryTotalPages"></span>
            <button @click="memoryNext()" :disabled="memoryPage >= memoryTotalPages">Next &#9654;</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SQL Console -->
    <section>
      <div class="section-header" @click="sections.sql = !sections.sql">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.sql }">&#9660;</span>
          SQL Console
        </h2>
        <small style="color:var(--pico-muted-color); font-size:0.75rem;" x-show="sqlRowCount > 0"
               x-text="sqlRowCount + ' rows'"></small>
      </div>
      <div x-show="sections.sql" x-transition>
        <div class="sql-card">
          <textarea class="sql-editor"
                    rows="8"
                    x-model="sqlQuery"
                    placeholder="Enter SQL query..."
                    @keydown.ctrl.enter="runQuery()"
                    @keydown.meta.enter="runQuery()"
                    spellcheck="false"></textarea>
          <div class="sql-toolbar">
            <div style="display:flex; align-items:center; gap:0.75rem;">
              <button @click="runQuery()" :disabled="sqlLoading">
                <span x-show="!sqlLoading">Run Query</span>
                <span x-show="sqlLoading">Running...</span>
              </button>
              <span class="sql-meta">Ctrl+Enter to execute</span>
            </div>
            <span class="sql-meta" x-show="sqlRowCount > 0" x-text="sqlRowCount + ' rows returned'"></span>
          </div>
          <!-- Error display -->
          <div class="sql-error" x-show="sqlError" x-text="sqlError"></div>
          <!-- Truncation warning -->
          <div class="sql-truncated" x-show="sqlTruncated">
            Truncated to 200 rows. Refine your query for complete results.
          </div>
          <!-- Results table -->
          <div class="sql-results" x-show="sqlColumns.length > 0">
            <table>
              <thead>
                <tr>
                  <template x-for="col in sqlColumns" :key="col">
                    <th x-text="esc(col)"></th>
                  </template>
                </tr>
              </thead>
              <tbody>
                <template x-for="(row, idx) in sqlRows" :key="idx">
                  <tr>
                    <template x-for="(cell, cidx) in row" :key="cidx">
                      <td x-text="esc(cell === null ? 'NULL' : String(cell))"></td>
                    </template>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Workflow DAG -->
    <section>
      <div class="section-header" @click="sections.dag = !sections.dag">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.dag }">&#9660;</span>
          Workflow DAG
        </h2>
        <small style="color:var(--pico-muted-color); font-size:0.75rem;" x-show="dagWorkflows.length > 0"
               x-text="dagWorkflows.length + ' workflows'"></small>
      </div>
      <div x-show="sections.dag" x-transition>
        <div class="dag-card">
          <div class="dag-toolbar">
            <select x-model="dagSelected" @change="renderDag(dagSelected)">
              <option value="">-- Select Workflow --</option>
              <template x-for="(wf, idx) in dagWorkflows" :key="idx">
                <option :value="idx" x-text="esc(wf.name) + ' (' + esc(wf.phase) + ')'"></option>
              </template>
            </select>
            <button @click="fetchWorkflows()">Refresh</button>
          </div>
          <div class="dag-canvas" id="dag-canvas">
            <div class="dag-empty" x-show="dagWorkflows.length === 0">
              No workflows found. Submit tasks via <code>/task</code> to see DAGs.
            </div>
          </div>
          <div class="dag-legend" x-show="dagWorkflows.length > 0">
            <div class="dag-legend-item"><span class="dag-legend-dot" style="background:#00d4ff;"></span> Running</div>
            <div class="dag-legend-item"><span class="dag-legend-dot" style="background:#22c55e;"></span> Succeeded</div>
            <div class="dag-legend-item"><span class="dag-legend-dot" style="background:#ef4444;"></span> Failed</div>
            <div class="dag-legend-item"><span class="dag-legend-dot" style="background:#6b7280;"></span> Pending</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Capabilities -->
    <section>
      <div class="section-header" @click="sections.caps = !sections.caps">
        <h2>
          <span class="chevron" :class="{ collapsed: !sections.caps }">&#9660;</span>
          System Capabilities
        </h2>
      </div>
      <div x-show="sections.caps" x-transition>
        <div id="capabilities-content"
             hx-get="/api/capabilities"
             hx-trigger="load"
             hx-swap="innerHTML">
          <p class="loading-text">Loading capabilities...</p>
        </div>
      </div>
    </section>

  </main>

  <footer class="footer">
    Antigravity Node v13.0 &mdash; Sovereign Agentic Platform &mdash; Apache-2.0
  </footer>

  <script>
    /**
     * Alpine.js component for dashboard local state.
     * All server interaction is handled by HTMX; Alpine manages
     * theme toggle and section expand/collapse only.
     */
    function dashboard() {
      return {
        theme: localStorage.getItem('ag-theme') || 'dark',
        globalStatus: 'unknown',
        globalStatusText: 'Checking...',
        sections: {
          health: true,
          services: true,
          links: true,
          budget: true,
          logs: false,
          memory: false,
          sql: false,
          dag: false,
          caps: false
        },

        // Budget state
        budgetLoaded: false,
        budgetSpend: 0,
        budgetLimit: 0,
        budgetCurrency: 'USD',
        budgetChart: null,

        // Log terminal state
        wsStatus: 'disconnected',
        wsStatusText: 'Disconnected',
        logTerminal: null,
        logWs: null,
        logReconnectTimer: null,

        // Memory browser state
        memorySearch: '',
        memoryEntries: [],
        memoryTotal: 0,
        memoryPage: 1,
        memoryPageSize: 25,
        memoryTotalPages: 1,
        memoryLoaded: false,

        // SQL Console state
        sqlQuery: 'SELECT * FROM memory_episodic LIMIT 10;',
        sqlColumns: [],
        sqlRows: [],
        sqlRowCount: 0,
        sqlTruncated: false,
        sqlError: '',
        sqlLoading: false,

        // Workflow DAG state
        dagWorkflows: [],
        dagSelected: '',
        dagCy: null,

        init() {
          document.documentElement.setAttribute('data-theme', this.theme);
          this.fetchBudget();
          this.fetchMemory(false);
          this.fetchWorkflows();
        },

        toggleTheme() {
          this.theme = this.theme === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', this.theme);
          localStorage.setItem('ag-theme', this.theme);
          // Update chart colors if chart exists
          if (this.budgetChart) {
            this.budgetChart.options.scales.x.ticks.color = this.theme === 'dark' ? '#94a3b8' : '#475569';
            this.budgetChart.options.scales.y.ticks.color = this.theme === 'dark' ? '#94a3b8' : '#475569';
            this.budgetChart.options.scales.x.grid.color = this.theme === 'dark' ? 'rgba(51,65,85,0.4)' : 'rgba(203,213,225,0.5)';
            this.budgetChart.options.scales.y.grid.color = this.theme === 'dark' ? 'rgba(51,65,85,0.4)' : 'rgba(203,213,225,0.5)';
            this.budgetChart.update();
          }
        },

        // Budget Dashboard
        fetchBudget() {
          var self = this;
          fetch('/api/budget/history')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              self.budgetSpend = data.current_spend || 0;
              self.budgetLimit = data.max_daily || 0;
              self.budgetCurrency = data.currency || 'USD';
              self.budgetLoaded = true;
              self.renderBudgetChart(data.hourly_spend || []);
            })
            .catch(function() {
              self.budgetLoaded = false;
            });
        },

        renderBudgetChart(hourlySpend) {
          var ctx = document.getElementById('budgetChart');
          if (!ctx) return;

          var labels = [];
          for (var i = 0; i < 24; i++) {
            labels.push(i.toString().padStart(2, '0') + ':00');
          }

          // Pad array to 24 if needed
          while (hourlySpend.length < 24) hourlySpend.push(0);

          var self = this;
          var gridColor = this.theme === 'dark' ? 'rgba(51,65,85,0.4)' : 'rgba(203,213,225,0.5)';
          var tickColor = this.theme === 'dark' ? '#94a3b8' : '#475569';

          if (this.budgetChart) {
            this.budgetChart.destroy();
          }

          this.budgetChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'Hourly Spend ($)',
                  data: hourlySpend,
                  backgroundColor: 'rgba(0, 212, 255, 0.6)',
                  borderColor: '#00d4ff',
                  borderWidth: 1,
                  borderRadius: 3,
                  order: 2
                },
                {
                  label: 'Budget Limit',
                  data: Array(24).fill(self.budgetLimit / 24),
                  type: 'line',
                  borderColor: '#ef4444',
                  borderWidth: 2,
                  borderDash: [6, 3],
                  pointRadius: 0,
                  fill: false,
                  order: 1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    color: tickColor,
                    font: { size: 11 },
                    boxWidth: 12,
                    padding: 12
                  }
                }
              },
              scales: {
                x: {
                  ticks: { color: tickColor, font: { size: 10 }, maxRotation: 0 },
                  grid: { color: gridColor }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: tickColor,
                    font: { size: 10 },
                    callback: function(v) { return '$' + v.toFixed(2); }
                  },
                  grid: { color: gridColor }
                }
              }
            }
          });
        },

        // Log Terminal
        toggleLogs() {
          this.sections.logs = !this.sections.logs;
          if (this.sections.logs && !this.logTerminal) {
            var self = this;
            // Small delay so DOM is ready
            setTimeout(function() { self.initTerminal(); }, 100);
          }
        },

        initTerminal() {
          var container = document.getElementById('terminal-container');
          if (!container || this.logTerminal) return;

          this.logTerminal = new Terminal({
            cols: 80,
            rows: 20,
            scrollback: 1000,
            theme: {
              background: '#0f172a',
              foreground: '#e2e8f0',
              cursor: '#00d4ff',
              selectionBackground: 'rgba(0, 212, 255, 0.3)'
            },
            fontFamily: '"Cascadia Code", "Fira Code", monospace',
            fontSize: 13,
            convertEol: false
          });
          this.logTerminal.open(container);
          this.logTerminal.writeln('\x1b[36m[Antigravity Node]\x1b[0m Connecting to log stream...\r');
          this.connectLogWs();
        },

        connectLogWs() {
          var self = this;
          if (this.logWs) {
            try { this.logWs.close(); } catch(e) {}
          }

          var wsProto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          var wsUrl = wsProto + '//' + window.location.host + '/api/ws/logs';

          self.wsStatus = 'reconnecting';
          self.wsStatusText = 'Connecting...';

          this.logWs = new WebSocket(wsUrl);

          this.logWs.onopen = function() {
            self.wsStatus = 'connected';
            self.wsStatusText = 'Connected';
            if (self.logTerminal) {
              self.logTerminal.writeln('\x1b[32m[Connected]\x1b[0m Log stream active.\r');
            }
          };

          this.logWs.onmessage = function(event) {
            if (self.logTerminal) {
              self.logTerminal.write(event.data);
            }
          };

          this.logWs.onclose = function() {
            self.wsStatus = 'disconnected';
            self.wsStatusText = 'Disconnected';
            if (self.logTerminal) {
              self.logTerminal.writeln('\x1b[31m[Disconnected]\x1b[0m Reconnecting in 5s...\r');
            }
            if (self.logReconnectTimer) clearTimeout(self.logReconnectTimer);
            self.logReconnectTimer = setTimeout(function() {
              self.wsStatus = 'reconnecting';
              self.wsStatusText = 'Reconnecting...';
              self.connectLogWs();
            }, 5000);
          };

          this.logWs.onerror = function() {
            self.wsStatus = 'disconnected';
            self.wsStatusText = 'Error';
          };
        },

        clearTerminal() {
          if (this.logTerminal) {
            this.logTerminal.clear();
          }
        },

        // Memory Browser
        fetchMemory(resetPage) {
          if (resetPage) this.memoryPage = 1;
          var self = this;
          var offset = (this.memoryPage - 1) * this.memoryPageSize;
          var url = '/api/memory?tenant_id=system&limit=' + this.memoryPageSize +
                    '&offset=' + offset +
                    '&search=' + encodeURIComponent(this.memorySearch);

          fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(data) {
              self.memoryEntries = data.entries || [];
              self.memoryTotal = data.total || 0;
              self.memoryTotalPages = Math.max(1, Math.ceil(self.memoryTotal / self.memoryPageSize));
              self.memoryLoaded = true;
            })
            .catch(function() {
              self.memoryEntries = [];
              self.memoryTotal = 0;
              self.memoryTotalPages = 1;
              self.memoryLoaded = true;
            });
        },

        memoryPrev() {
          if (this.memoryPage > 1) {
            this.memoryPage--;
            this.fetchMemory(false);
          }
        },

        memoryNext() {
          if (this.memoryPage < this.memoryTotalPages) {
            this.memoryPage++;
            this.fetchMemory(false);
          }
        },

        // SQL Console
        runQuery() {
          if (this.sqlLoading) return;
          var query = (this.sqlQuery || '').trim();
          if (!query) {
            this.sqlError = 'Query cannot be empty.';
            return;
          }
          this.sqlLoading = true;
          this.sqlError = '';
          this.sqlColumns = [];
          this.sqlRows = [];
          this.sqlRowCount = 0;
          this.sqlTruncated = false;

          var self = this;
          fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sql: query })
          })
            .then(function(r) {
              if (!r.ok) {
                return r.json().then(function(errData) {
                  throw new Error(errData.detail || errData.error || ('Server error: ' + r.status));
                }).catch(function(parseErr) {
                  if (parseErr.message && parseErr.message !== ('Server error: ' + r.status)) throw parseErr;
                  throw new Error('Server error: ' + r.status);
                });
              }
              return r.json();
            })
            .then(function(data) {
              self.sqlColumns = data.columns || [];
              self.sqlRows = data.rows || [];
              self.sqlRowCount = data.row_count || 0;
              self.sqlTruncated = data.truncated || false;
              self.sqlLoading = false;
            })
            .catch(function(err) {
              self.sqlError = err.message || 'Failed to execute query.';
              self.sqlLoading = false;
            });
        },

        // Workflow DAG
        fetchWorkflows() {
          var self = this;
          fetch('/api/workflows')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              self.dagWorkflows = data.workflows || [];
              if (self.dagWorkflows.length > 0 && self.dagSelected === '') {
                self.dagSelected = '0';
                self.renderDag('0');
              } else if (self.dagWorkflows.length === 0) {
                self.dagSelected = '';
                if (self.dagCy) {
                  self.dagCy.destroy();
                  self.dagCy = null;
                }
              }
            })
            .catch(function() {
              self.dagWorkflows = [];
              self.dagSelected = '';
            });
        },

        renderDag(workflowIndex) {
          var idx = parseInt(workflowIndex, 10);
          if (isNaN(idx) || idx < 0 || idx >= this.dagWorkflows.length) return;

          var wf = this.dagWorkflows[idx];
          var nodes = wf.nodes || [];
          if (nodes.length === 0) return;

          var container = document.getElementById('dag-canvas');
          if (!container) return;

          // Color map by phase
          var phaseColors = {
            'Running': '#00d4ff',
            'Succeeded': '#22c55e',
            'Failed': '#ef4444',
            'Pending': '#6b7280'
          };

          // Build Cytoscape elements
          var elements = [];

          nodes.forEach(function(node) {
            elements.push({
              data: {
                id: node.id,
                label: node.name || node.id,
                bgColor: phaseColors[node.phase] || '#6b7280'
              }
            });
          });

          nodes.forEach(function(node) {
            if (node.dependencies && node.dependencies.length > 0) {
              node.dependencies.forEach(function(depId) {
                elements.push({
                  data: {
                    id: depId + '->' + node.id,
                    source: depId,
                    target: node.id
                  }
                });
              });
            }
          });

          // Destroy previous instance
          if (this.dagCy) {
            this.dagCy.destroy();
            this.dagCy = null;
          }

          this.dagCy = cytoscape({
            container: container,
            elements: elements,
            style: [
              {
                selector: 'node',
                style: {
                  'label': 'data(label)',
                  'background-color': 'data(bgColor)',
                  'color': '#e2e8f0',
                  'text-valign': 'bottom',
                  'text-halign': 'center',
                  'font-size': '11px',
                  'font-family': '"Cascadia Code", "Fira Code", monospace',
                  'text-margin-y': 6,
                  'width': 32,
                  'height': 32,
                  'border-width': 2,
                  'border-color': 'data(bgColor)',
                  'text-outline-width': 2,
                  'text-outline-color': '#0c1222'
                }
              },
              {
                selector: 'edge',
                style: {
                  'width': 2,
                  'line-color': '#334155',
                  'target-arrow-color': '#00d4ff',
                  'target-arrow-shape': 'triangle',
                  'curve-style': 'bezier',
                  'arrow-scale': 0.8
                }
              }
            ],
            layout: {
              name: 'breadthfirst',
              directed: true,
              spacingFactor: 1.5,
              padding: 30,
              animate: false
            },
            userZoomingEnabled: true,
            userPanningEnabled: true,
            boxSelectionEnabled: false
          });
        },

        formatTime(ts) {
          if (!ts) return '';
          try {
            var d = new Date(ts);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          } catch(e) { return esc(String(ts)); }
        },

        truncate(s, len) {
          if (!s) return '';
          var safe = esc(String(s));
          return safe.length > len ? safe.substring(0, len) + '...' : safe;
        },

        esc: esc
      };
    }

    /**
     * HTMX afterSwap handler: parse the /health JSON response and render
     * it as HTML into #health-content. Also update Alpine global status.
     */
    document.addEventListener('htmx:beforeSwap', function(event) {
      var target = event.detail.target;

      // Handle /api/health response
      if (target && target.id === 'health-content') {
        event.detail.shouldSwap = true;
        try {
          var data = JSON.parse(event.detail.xhr.responseText);
          event.detail.serverResponse = renderHealth(data);
          // Update global status via Alpine
          var alpineRoot = document.querySelector('[x-data]');
          if (alpineRoot && alpineRoot.__x) {
            alpineRoot.__x.$data.globalStatus = data.status || 'unknown';
            alpineRoot.__x.$data.globalStatusText = (data.status === 'healthy') ? 'All Systems Healthy' : 'Degraded';
          } else if (alpineRoot && window.Alpine) {
            // Alpine v3 approach
            Alpine.evaluate(alpineRoot, function() {
              this.globalStatus = data.status || 'unknown';
              this.globalStatusText = (data.status === 'healthy') ? 'All Systems Healthy' : 'Degraded';
            });
          }
          // Try direct data access (Alpine v3 with $data on element)
          try {
            var scope = Alpine.$data(alpineRoot);
            scope.globalStatus = data.status || 'unknown';
            scope.globalStatusText = (data.status === 'healthy') ? 'All Systems Healthy' : 'Degraded';
          } catch(e) { /* Alpine not ready yet, that is fine */ }
        } catch (e) {
          event.detail.serverResponse = '<p class="loading-text">Orchestrator unreachable &mdash; retrying...</p>';
          try {
            var alpineRoot2 = document.querySelector('[x-data]');
            var scope2 = Alpine.$data(alpineRoot2);
            scope2.globalStatus = 'unhealthy';
            scope2.globalStatusText = 'Unreachable';
          } catch(e2) { /* ignore */ }
        }
      }

      // Handle /api/capabilities response
      if (target && target.id === 'capabilities-content') {
        event.detail.shouldSwap = true;
        try {
          var capData = JSON.parse(event.detail.xhr.responseText);
          event.detail.serverResponse = renderCapabilities(capData);
        } catch (e) {
          event.detail.serverResponse = '<p class="loading-text">Could not load capabilities.</p>';
        }
      }
    });

    /**
     * Handle HTMX errors (network failures, timeouts).
     */
    document.addEventListener('htmx:responseError', function(event) {
      var target = event.detail.target;
      if (target && target.id === 'health-content') {
        target.innerHTML = '<p class="loading-text">Orchestrator unreachable &mdash; retrying in 10s...</p>';
        try {
          var scope = Alpine.$data(document.querySelector('[x-data]'));
          scope.globalStatus = 'unhealthy';
          scope.globalStatusText = 'Unreachable';
        } catch(e) { /* ignore */ }
      }
    });

    /**
     * Render health JSON into HTML cards.
     */
    function renderHealth(data) {
      if (!data || !data.levels) {
        return '<p class="loading-text">No health data available.</p>';
      }

      var html = '<div class="health-grid">';
      data.levels.forEach(function(level) {
        html += '<div class="health-card">';
        html += '<div class="health-card-header">';
        html += '<span class="layer-tag">' + esc(level.level) + '</span>';
        html += '<span class="layer-name">' + esc(level.name) + '</span>';
        html += '</div>';

        if (level.checks && level.checks.length > 0) {
          level.checks.forEach(function(check) {
            var ok = check.healthy;
            html += '<div class="check-row">';
            html += '<span class="check-name">' + esc(check.name) + '</span>';
            html += '<span class="check-status ' + (ok ? 'ok' : 'fail') + '">' + (ok ? 'OK' : 'DOWN') + '</span>';
            html += '</div>';
          });
        } else {
          html += '<div class="check-row"><span class="check-name" style="color:var(--pico-muted-color)">No checks</span></div>';
        }

        html += '</div>';
      });
      html += '</div>';
      return html;
    }

    /**
     * Render capabilities JSON into HTML.
     */
    function renderCapabilities(data) {
      if (!data) return '<p class="loading-text">No data.</p>';

      var html = '<div class="capabilities-panel"><div class="cap-grid">';

      // Protocols
      html += '<div class="cap-group">';
      html += '<h4>Protocols</h4>';
      if (data.protocols) {
        data.protocols.forEach(function(p) {
          html += '<div class="cap-item"><code>' + esc(p) + '</code></div>';
        });
      }
      html += '</div>';

      // Endpoints
      html += '<div class="cap-group">';
      html += '<h4>Endpoints</h4>';
      if (data.endpoints) {
        Object.keys(data.endpoints).forEach(function(key) {
          html += '<div class="cap-item">' + esc(key) + ' &rarr; <code>' + esc(data.endpoints[key]) + '</code></div>';
        });
      }
      html += '</div>';

      // MCP Servers
      html += '<div class="cap-group">';
      html += '<h4>MCP Servers</h4>';
      if (data.mcp_servers) {
        Object.keys(data.mcp_servers).forEach(function(key) {
          var srv = data.mcp_servers[key];
          html += '<div class="cap-item"><code>' + esc(key) + '</code> (' + esc(srv.transport || '') + ')</div>';
        });
      }
      html += '</div>';

      // Memory
      html += '<div class="cap-group">';
      html += '<h4>Memory Systems</h4>';
      if (data.memory) {
        Object.keys(data.memory).forEach(function(key) {
          html += '<div class="cap-item">' + esc(key) + ' &mdash; ' + esc(data.memory[key]) + '</div>';
        });
      }
      html += '</div>';

      // Budget
      html += '<div class="cap-group">';
      html += '<h4>Budget</h4>';
      if (data.budget) {
        html += '<div class="cap-item">Model: <code>' + esc(data.budget.model || 'N/A') + '</code></div>';
        html += '<div class="cap-item">Daily limit: <code>' + esc(data.budget.max_daily || 'N/A') + '</code></div>';
      }
      html += '</div>';

      html += '</div></div>';
      return html;
    }

    /** Simple HTML escaping. */
    function esc(s) {
      if (s === null || s === undefined) return '';
      var d = document.createElement('div');
      d.appendChild(document.createTextNode(String(s)));
      return d.innerHTML;
    }
  </script>
</body>
</html>
