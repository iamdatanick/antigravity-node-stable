events { worker_connections 1024; }
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;

    # Compression
    gzip on;
    gzip_types text/css application/javascript application/json image/svg+xml;
    gzip_min_length 256;

    # Docker embedded DNS resolver
    resolver 127.0.0.11 valid=5s ipv6=off;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    server {
        listen 80;

        # Static SPA assets with caching
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;

            # Cache static assets aggressively (Vite hashes filenames)
            location ~* \.(js|css|svg|png|jpg|jpeg|gif|ico|woff2?)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # WebSocket logs — must come before /api/
        location /api/ws/ {
            set $orch orchestrator:8080;
            rewrite ^/api/ws/(.*) /ws/$1 break;
            proxy_pass http://$orch;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
        }

        # Budget proxy — /api/budget/health and /api/budget/*
        location /api/budget/ {
            set $budget budget-proxy:4000;
            rewrite ^/api/budget/(.*) /$1 break;
            proxy_pass http://$budget;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_intercept_errors off;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
        }

        # All other API routes → orchestrator
        location /api/ {
            set $orch orchestrator:8080;
            rewrite ^/api/(.*) /$1 break;
            proxy_pass http://$orch;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 5s;
            proxy_read_timeout 120s;
            proxy_send_timeout 120s;

            # Pass upstream errors through (don't intercept 503 etc.)
            proxy_intercept_errors off;

            # SSE streaming support
            proxy_buffering off;
            proxy_cache off;
        }
    }
}
